name: CI/CD Pipeline

on:
  push:
    branches: [ main, 'release/*' ]
  pull_request:
    branches: [ main, 'release/*' ]

permissions:
  contents: read
  security-events: write

jobs:
  load-overrides:
    name: Load Developer Overrides
    uses: ./.github/workflows/load-overrides.yml

  build:
    name: Build & Test Job
    needs: [load-overrides]
    uses: ./.github/workflows/build-application.yml
    with:
      java-version: '17'
      maven-version: '3.8.6'

  security-scan:
    name: Snyk Analysis
    needs: [build, load-overrides]
    uses: ./.github/workflows/security-scanning.yml
    with:
      java-version: '17'
      run-container-scan: false
      thresholds: ${{ needs.load-overrides.outputs.thresholds }}
    secrets:
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      SNYK_ORG_ID: ${{ secrets.SNYK_ORG_ID }}

  code-quality:
    name: SonarQube Cloud Analysis
    needs: [build, security-scan, load-overrides]
    uses: ./.github/workflows/quality-analysis.yml
    with:
      java-version: '17'
      thresholds: ${{ needs.load-overrides.outputs.thresholds }}
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      SONAR_ORGANIZATION: ${{ secrets.SONAR_ORGANIZATION }}
      SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
