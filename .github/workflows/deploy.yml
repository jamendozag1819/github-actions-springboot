name: CI/CD Pipeline

permissions:
  contents: read
  security-events: write

on:
  push:
    branches: [ main, '*release*' ]
  pull_request:
    branches: [ main, '*release*' ]
  workflow_dispatch:
    inputs:
      override_gates:
        description: 'AnulaciÃ³n de la puerta de despliegue seguro (solo para despliegue de emergencia)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

env:
  JAVA_VERSION: '17'
  MAVEN_VERSION: '3.8.6'

jobs:

  security-scan:
    name: Snyk Analysis
    uses: ./.github/workflows/security-scanning.yml
    with:
      java-version: '17'
    secrets:
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      SNYK_ORG_ID: ${{ secrets.SNYK_ORG_ID }}

  code-quality:
    name: SonarQube Cloud Analysis
    needs: [ security-scan ]
    uses: ./.github/workflows/quality-analysis.yml
    with:
      java-version: '17'
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      SONAR_ORGANIZATION: ${{ secrets.SONAR_ORGANIZATION }}
      SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}

  extract-jira:
    name: Extract JIRA Key
    runs-on: ubuntu-latest
    outputs:
      issue: ${{ steps.extract.outputs.issue }}
    steps:
      - name: Extract JIRA Key
        id: extract
        run: |
          BRANCH="${GITHUB_REF##*/}"
          ISSUE=$(echo "$BRANCH" | grep -oE '[A-Z]+-[0-9]+')
          echo "issue=$ISSUE" >> $GITHUB_OUTPUT

      - name: Show Extracted Issue
        run: |
          echo "Jira issue: ${{ steps.extract.outputs.issue }}"

  jira-update:
    name: Update Jira
    needs: [ code-quality, extract-jira ]
    uses: ./.github/workflows/jira.yml
    with:
      issue-key: ${{ needs.extract-jira.outputs.issue }}
      new-status: "31"
    secrets:
      JIRA_URL: ${{ secrets.JIRA_URL }}
      JIRA_USER: ${{ secrets.JIRA_USER }}
      JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
