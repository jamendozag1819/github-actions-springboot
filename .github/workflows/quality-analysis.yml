name: 'Code Quality Analysis'

on:
  workflow_call:
    inputs:
      java-version:
        description: 'Java version to use'
        required: false
        type: string
        default: '17'
      thresholds:
        description: 'Developer-effective threshold config'
        required: false
        type: string

    secrets:
      SONAR_TOKEN:
        required: true
      SONAR_ORGANIZATION:
        required: true
      SONAR_PROJECT_KEY:
        required: true
        
    outputs:
      quality-gate-status:
        description: 'Quality gate status (PASSED/FAILED/UNKNOWN)'
        value: ${{ jobs.code-quality.outputs.quality-gate-status }}
      sonarqube-configured:
        description: 'Whether SonarQube is properly configured'
        value: ${{ jobs.code-quality.outputs.sonarqube-configured }}
      sonar-gate-exit-code:
        description: 'Exit code from SonarQube quality gate analysis'
        value: ${{ jobs.code-quality.outputs.sonar-gate-exit-code }}
      threshold-status:
        description: 'Custom threshold evaluation result'
        value: ${{ jobs.code-quality.outputs.threshold-status }}

jobs:
  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    
    env:
      SONAR_PROJECT_KEY_DEBUGIN: ${{ secrets.SONAR_PROJECT_KEY }}

    outputs:
      quality-gate-status: ${{ steps.sonarqube_scan.outputs.QUALITY_GATE_STATUS }}
      sonarqube-configured: ${{ steps.sonarqube_scan.outputs.SONARQUBE_CONFIGURED }}
      sonar-gate-exit-code: ${{ steps.sonarqube_scan.outputs.SONAR_GATE_EXIT_CODE }}
      threshold-status: ${{ steps.evaluate_thresholds.outputs.FINAL_THRESHOLD_STATUS }}

    steps:

      # ========================
      # CHECKOUT & BUILD SETUP
      # ========================
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Java and Maven
        uses: ./.github/actions/setup-java-maven
        with:
          java-version: ${{ inputs.java-version }}
          
      - name: Download build artifacts
        uses: ./.github/actions/download-build-artifacts

      - name: Download classes
        uses: actions/download-artifact@v4
        with:
         name: build-classes
         path: target/classes

      # ========================
      # LOAD THRESHOLDS.JSON
      # ========================
      - name: Load thresholds JSON
        id: load_thresholds
        run: |
          echo "Loading dynamic thresholdsâ€¦"

          if [ -z "${{ inputs.thresholds }}" ]; then
            echo "âš ï¸ No thresholds received â€” using empty JSON"
            echo "{}" > thresholds.json
          else
            echo "${{ inputs.thresholds }}" > thresholds.json
          fi

          echo "Threshold file content:"
          cat thresholds.json


      # ========================
      # VALIDATE SONAR CONFIG
      # ========================
      - name: Validate SonarQube configuration
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_ORGANIZATION: ${{ secrets.SONAR_ORGANIZATION }}
          SONAR_PROJECT_KEY: ${{ env.SONAR_PROJECT_KEY_DEBUGIN }}
        run: |
          chmod +x sonarqube-cloud-scanning/scripts/validate-sonarqube.sh
          
          ./sonarqube-cloud-scanning/scripts/validate-sonarqube.sh \
          && echo "SONARQUBE_VALIDATED=true" >> $GITHUB_ENV \
          || echo "SONARQUBE_VALIDATED=false" >> $GITHUB_ENV


      # ========================
      # RUN SONARQUBE ANALYSIS
      # ========================
      - name: Run SonarQube Cloud Analysis
        id: sonarqube_scan
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_ORGANIZATION: ${{ secrets.SONAR_ORGANIZATION }}
          SONAR_PROJECT_KEY: ${{ env.SONAR_PROJECT_KEY_DEBUGIN }}
        run: |
          if [ -z "$SONAR_TOKEN" ] || [ "$SONARQUBE_VALIDATED" = "false" ]; then
            echo "âš ï¸ SonarQube Cloud not configured â€” skipping analysis"
            echo "SONARQUBE_CONFIGURED=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "SONARQUBE_CONFIGURED=true" >> $GITHUB_OUTPUT

          chmod +x mvnw

          ./mvnw sonar:sonar \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.login=$SONAR_TOKEN \
            -Dsonar.organization=$SONAR_ORGANIZATION \
            -Dsonar.projectKey=${{ env.SONAR_PROJECT_KEY_DEBUGIN}} \
            -Dsonar.projectName="CI/CD Pipeline Security POC" \
            -Dsonar.projectVersion=1.0.0 \
            -Dsonar.java.binaries=target/classes \
            -Dsonar.qualitygate.wait=true || SONAR_EXIT_CODE=$?

          if [ "${SONAR_EXIT_CODE:-0}" -eq 0 ]; then
            echo "QUALITY_GATE_STATUS=PASSED" >> $GITHUB_OUTPUT
          else
            echo "QUALITY_GATE_STATUS=FAILED" >> $GITHUB_OUTPUT
          fi

          echo "SONAR_GATE_EXIT_CODE=${SONAR_EXIT_CODE:-0}" >> $GITHUB_OUTPUT


      # ========================
      # MERGE SONAR RESULTS + THRESHOLDS
      # ========================
      - name: Evaluate custom Sonar thresholds
        id: evaluate_thresholds
        run: |
          echo "ðŸ“Š Evaluating thresholds for Sonar metricsâ€¦"
          RESULT_FILE="sonarqube-cloud-scanning/results/quality-gate-result.json"

          # Safe extractor for Sonar metrics (handles null, missing, strings)
          safe_number() {
          value=$(jq -r "$1 // 0" "$2" 2>/dev/null)
          value=$(echo "$value" | sed 's/[^0-9.\-]//g')
          if [ -z "$value" ]; then value=0; fi
          echo "$value"
          }

          # Extract Sonar metrics
          coverage=$(safe_number '.metrics.coverage' "$RESULT_FILE")
          code_smells=$(safe_number '.metrics.code_smells' "$RESULT_FILE")
          bugs=$(safe_number '.metrics.bugs' "$RESULT_FILE")
          duplication=$(safe_number '.metrics.duplicated_lines_density' "$RESULT_FILE")
          vulnerabilities=$(safe_number '.metrics.vulnerabilities' "$RESULT_FILE")

          echo "Coverage: $coverage"
          echo "Code smells: $code_smells"
          echo "Bugs: $bugs"
          echo "Duplication: $duplication"
          echo "Vulnerabilities: $vulnerabilities"

          # Thresholds JSON from load-overrides.yml
          TH_FILE="thresholds.json"

          coverage_min=$(safe_number '.coverage_min' "$TH_FILE")
          code_smells_max=$(safe_number '.code_smells_max' "$TH_FILE")
          bugs_max=$(safe_number '.bugs_max' "$TH_FILE")
          duplication_max=$(safe_number '.duplication_max_percent' "$TH_FILE")
          sonar_vulns_max=$(safe_number '.sonar_vulns_max' "$TH_FILE")

          status="PASSED"

          # Apply threshold rules
          if (( $(echo "$coverage < $coverage_min" | bc -l) )); then status="FAILED"; fi
          if (( $(echo "$code_smells > $code_smells_max" | bc -l) )); then status="FAILED"; fi
          if (( $(echo "$bugs > $bugs_max" | bc -l) )); then status="FAILED"; fi
          if (( $(echo "$duplication > $duplication_max" | bc -l) )); then status="FAILED"; fi
          if (( $(echo "$vulnerabilities > $sonar_vulns_max" | bc -l) )); then status="FAILED"; fi

          echo "FINAL_THRESHOLD_STATUS=$status" >> $GITHUB_OUTPUT


      # ========================
      # UPLOAD RESULTS FOR UI
      # ========================
      - name: Generate quality summary
        if: steps.sonarqube_scan.outputs.SONARQUBE_CONFIGURED == 'true'
        uses: ./.github/actions/generate-quality-summary
        with:
          results-file: sonarqube-cloud-scanning/results/quality-gate-result.json
          project-key: ${{ env.SONAR_PROJECT_KEY_DEBUGIN }}
          branch-name: ${{ github.ref_name }}

      - name: Upload quality results
        uses: actions/upload-artifact@v4
        with:
          name: quality-results
          path: sonarqube-cloud-scanning/results/quality-gate-result.json
          if-no-files-found: warn
          retention-days: 1
