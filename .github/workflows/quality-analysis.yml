# ============================================================
# Workflow: SonarQube Cloud Analysis
# Ejecuta análisis de calidad con SonarCloud y valida gates.
# Permite ser llamado desde otros workflows mediante workflow_call.
# ============================================================

name: SonarQube Cloud Analysis

on:
  workflow_call:
    inputs:
      java-version:
        description: "Versión de Java a utilizar"
        required: true
        type: string

      project-key:
        description: "Sonar Project Key (opcional, si no se envía usa el secreto)"
        required: false
        type: string

    secrets:
      SONAR_TOKEN:
        required: true
      SONAR_ORGANIZATION:
        required: true
      SONAR_PROJECT_KEY:
        required: true
      JIRA_API_TOKEN:
        required: true
      JIRA_URL:
        required: true
      JIRA_USER:
        required: true

# ============================================================
# JOB PRINCIPAL — Sonar Analysis
# ============================================================

jobs:
  sonar-analysis:
    name: SonarQube Code Quality Scan
    runs-on: ubuntu-latest

    steps:
      # ------------------------
      # 1. Descargar código
      # ------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------
      # 2. Instalar Java correcto
      # ------------------------
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ inputs.java-version }}

      # ------------------------
      # 3. Compilar el proyecto (genera .class y cobertura)
      # ------------------------
      - name: Build with Maven
        run: mvn -B clean verify

      # ------------------------
      # 4. Depuración de reportes (por si Jacoco no aparece)
      # ------------------------
      - name: Debug coverage paths
        run: |
         echo "=== surefire-reports ==="
         ls -R target/surefire-reports || echo "NO SUREFIRE REPORTS"

         echo "=== jacoco report ==="
         ls -R target/site/jacoco || echo "NO JACOCO REPORT"
         cat target/site/jacoco/jacoco.xml || echo "JACOCO XML EMPTY"

      # ------------------------
      # 5. Instalar Sonar Scanner CLI
      # ------------------------
      - name: Install Sonar Scanner
        run: |
          curl -sSLo sonar.zip \
            https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
          unzip sonar.zip -d $HOME
          mv $HOME/sonar-scanner-* $HOME/sonar-scanner
          echo "$HOME/sonar-scanner/bin" >> $GITHUB_PATH

      # ------------------------
      # 6. Ejecutar análisis Sonar con las rutas correctas
      # ------------------------
      - name: Run Sonar Scanner
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_ORG: ${{ secrets.SONAR_ORGANIZATION }}
          # Si el workflow_call envió un project-key se usa ese, sino el secreto
          SONAR_PROJECT: ${{ inputs.project-key || secrets.SONAR_PROJECT_KEY }}
        run: |
          echo "Project key to scan: $SONAR_PROJECT"

          sonar-scanner \
           -Dsonar.organization="${SONAR_ORG}" \
           -Dsonar.projectKey="${SONAR_PROJECT}" \
           -Dsonar.sources=src/main/java \
           -Dsonar.tests=src/test/java \
           -Dsonar.java.binaries=target/classes \
           -Dsonar.java.test.binaries=target/test-classes \
           -Dsonar.junit.reportPaths=target/surefire-reports \
           -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml \
           -Dsonar.host.url="https://sonarcloud.io" \
           -Dsonar.token="${SONAR_TOKEN}"

      # ------------------------
      # 7. Ejecutar script de Gating (gatr-08/09/14 + Jira)
      # ------------------------
      - name: Sonar Quality Gate Validation
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_PROJECT: ${{ inputs.project-key || secrets.SONAR_PROJECT_KEY }}
        run: |
          echo "Running gating for $SONAR_PROJECT..."
          python3 scripts/sonar_gating.py \
           --sonar-host "https://sonarcloud.io" \
           --token "${SONAR_TOKEN}" \
           --project-key "${SONAR_PROJECT}" \
           --threshold-file "gating-configs/sonar_thresholds.json" \
           --branch "${GITHUB_REF#refs/heads/}" \
           --environment "DEV" \
           --jira-url "${{ secrets.JIRA_URL }}" \
           --jira-user "${{ secrets.JIRA_USER }}" \
           --jira-token "${{ secrets.JIRA_API_TOKEN }}" \
           --app-id "GATES" \
           --wait
