name: 'Code Quality Analysis'

on:
  workflow_call:
    inputs:
      java-version:
        description: 'Java version to use'
        required: false
        type: string
        default: '17'

    secrets:
      SONAR_TOKEN:
        required: true
      SONAR_ORGANIZATION:
        required: true
      SONAR_PROJECT_KEY:
        required: true

    outputs:
      quality-gate-status:
        description: 'Quality gate status (PASSED/FAILED/UNKNOWN)'
        value: ${{ jobs.code-quality.outputs.quality-gate-status }}
      sonarqube-configured:
        description: 'Whether SonarQube is properly configured'
        value: ${{ jobs.code-quality.outputs.sonarqube-configured }}
      sonar-gate-exit-code:
        description: 'Exit code from SonarQube quality gate analysis'
        value: ${{ jobs.code-quality.outputs.sonar-gate-exit-code }}

jobs:

  code-quality:
    name: SonarCloud Analysis (Multistack)
    runs-on: ubuntu-latest

    outputs:
      quality-gate-status: ${{ steps.sonar_scan.outputs.quality_gate_status }}
      sonarqube-configured: ${{ steps.sonar_scan.outputs.sonarqube_configured }}
      sonar-gate-exit-code: ${{ steps.sonar_scan.outputs.sonar_gate_exit_code }}

    steps:

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: ./.github/actions/download-build-artifacts
        continue-on-error: true

      - name: Download test results
        uses: actions/download-artifact@v4
        with:
          name: test-results
          path: .
        continue-on-error: true

      ########################################################
      # CALL YOUR ACTION HERE
      ########################################################
      - name: Run Sonar Code Analysis (Composite Action)
        id: sonar_scan
        uses: actions/sonar-code-analysis
        with:
          app-path: "."
          sonar-host-url: "https://sonarcloud.io"
          tech-version: ${{ inputs.java-version }}
          project-path: "."
          sonar-token: ${{ secrets.SONAR_TOKEN }}
          sonar-organization: ${{ secrets.SONAR_ORGANIZATION }}
          sonar-project-key: ${{ secrets.SONAR_PROJECT_KEY }}
          sonar-branch: ${{ github.ref_name }}
          app-techstack: "auto"


      ########################################################

      - name: Upload quality results
        uses: actions/upload-artifact@v4
        with:
          name: quality-results
          path: sonarqube-cloud-scanning/results
          if-no-files-found: warn
          retention-days: 3
