name: SonarQube Cloud Analysis

on:
  workflow_call:
    inputs:
      java-version:
        description: "Java version to use"
        required: true
        type: string
      project-key:
        description: "Sonar Project Key"
        required: false
        type: string

    secrets:
      SONAR_TOKEN:
        required: true
      SONAR_ORGANIZATION:
        required: true
      SONAR_PROJECT_KEY:
        required: true

jobs:
  sonar-analysis:
    name: SonarQube Code Quality Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ inputs.java-version }}

      # ----------------------------------
      # Build project to generate Java .class files
      # ----------------------------------
      - name: Build with Maven
        run: mvn -B clean verify

      - name: Install Sonar Scanner
        run: |
          curl -sSLo sonar.zip \
            https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
          unzip sonar.zip -d $HOME
          mv $HOME/sonar-scanner-* $HOME/sonar-scanner
          echo "$HOME/sonar-scanner/bin" >> $GITHUB_PATH

      # ----------------------------------
      # Run Sonar Analysis (FIXED)
      # ----------------------------------
      - name: Run Sonar Scanner
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_ORG: ${{ secrets.SONAR_ORGANIZATION }}
          SONAR_PROJECT: ${{ inputs.project-key || secrets.SONAR_PROJECT_KEY }}
        run: |
          echo "Project key to scan: $SONAR_PROJECT"

          sonar-scanner \
            -Dsonar.organization="${SONAR_ORG}" \
            -Dsonar.projectKey="${SONAR_PROJECT}" \
            -Dsonar.sources=./ \
            -Dsonar.java.binaries=target/classes \
            -Dsonar.host.url="https://sonarcloud.io" \
            -Dsonar.token="${SONAR_TOKEN}"

      # ----------------------------------
      # Sonar Gating Script
      # ----------------------------------
      - name: Sonar Quality Gate Validation
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_PROJECT: ${{ inputs.project-key || secrets.SONAR_PROJECT_KEY }}
        run: |
          echo "Running gating for $SONAR_PROJECT..."
          python3 ./scripts/sonar_gating.py \
            --sonar-host "https://sonarcloud.io" \
            --token "${SONAR_TOKEN}" \
            --project-key "${SONAR_PROJECT}" \
            --threshold-file "gating-configs/sonar_thresholds.json" \
            --wait \
            --branch "${GITHUB_REF#refs/heads/}"
