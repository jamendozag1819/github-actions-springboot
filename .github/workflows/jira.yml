name: Jira Integration

on:
  workflow_call:
    inputs:
      issue-key:
        description: "Clave del ticket Jira (ej: KAN-123)"
        required: true
        type: string

      new-status:
        description: "ID de la transici√≥n Jira (no el nombre)"
        required: false
        type: string
        default: ""

    secrets:
      JIRA_URL:
        required: true
      JIRA_USER:
        required: true
      JIRA_API_TOKEN:
        required: true

jobs:

  get-transitions:
    name: Get Jira Transitions
    runs-on: ubuntu-latest
    outputs:
      transitions: ${{ steps.fetch.outputs.transitions }}
    steps:
      - name: Fetch available Jira transitions
        id: fetch
        run: |
          echo "üîç Getting transitions for issue ${ISSUE_KEY}"
          ISSUE_KEY="${{ inputs.issue-key }}"

          RESPONSE=$(curl -s -u "${{ secrets.JIRA_USER }}:${{ secrets.JIRA_API_TOKEN }}" \
            -H "Accept: application/json" \
            "${{ secrets.JIRA_URL }}/rest/api/3/issue/$ISSUE_KEY/transitions")

          echo "Transitions found:"
          echo "$RESPONSE"

          # Export transitions to output
          echo "transitions<<EOF" >> $GITHUB_OUTPUT
          echo "$RESPONSE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT


  update-jira:
    name: Update Jira Ticket
    runs-on: ubuntu-latest
    needs: get-transitions
    steps:
      - name: Show available transitions
        run: |
          echo "üìã Available transitions for issue ${{ inputs.issue-key }}:"
          echo "${{ needs.get-transitions.outputs.transitions }}"

      - name: Update Jira Ticket Status
        if: ${{ inputs.new-status != '' }}
        run: |
          echo "üìå Updating Jira issue: ${{ inputs.issue-key }}"
          echo "‚û°Ô∏è Target transition ID: ${{ inputs.new-status }}"

          curl -X POST \
            -H "Content-Type: application/json" \
            -u "${{ secrets.JIRA_USER }}:${{ secrets.JIRA_API_TOKEN }}" \
            -d "{
              \"transition\": { \"id\": \"${{ inputs.new-status }}\" }
            }" \
            "${{ secrets.JIRA_URL }}/rest/api/3/issue/${{ inputs.issue-key }}/transitions"
