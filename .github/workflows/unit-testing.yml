name: 'Unit Testing'

on:
  workflow_call:
    inputs:
      java-version:
        description: 'Java version to use'
        required: false
        type: string
        default: '17'
      maven-version:
        description: 'Maven version to use'
        required: false
        type: string
        default: '3.8.6'
      coverage-threshold:
        description: 'Minimum code coverage percentage'
        required: false
        type: number
        default: 50
      fail-on-coverage:
        description: 'Fail if coverage is below threshold'
        required: false
        type: boolean
        default: false

jobs:
  unit-tests:
    name: Run Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java and Maven
        uses: ./.github/actions/setup-java-maven
        with:
          java-version: ${{ inputs.java-version }}

      - name: Run tests with coverage
        run: |
          mvn clean test
          echo "Coverage threshold: ${{ inputs.coverage-threshold }}"
          echo "Fail on low coverage: ${{ inputs.fail-on-coverage }}"

      # Aqu√≠ podr√≠as agregar l√≥gica para verificar la cobertura y fallar si es necesario
	  - name: Verificar cobertura con JaCoCo
        run: |
          echo "Verificando cobertura de c√≥digo..."
          JACOCO_FILE=target/site/jacoco/jacoco.xml

          if [ ! -f "$JACOCO_FILE" ]; then
            echo "‚ùå No se encontr√≥ el archivo de cobertura: $JACOCO_FILE"
            exit 1
          fi

          COVERED=$(xmllint --xpath "string(//counter[@type='INSTRUCTION']/@covered)" $JACOCO_FILE)
          MISSED=$(xmllint --xpath "string(//counter[@type='INSTRUCTION']/@missed)" $JACOCO_FILE)

          TOTAL=$((COVERED + MISSED))
          if [ "$TOTAL" -eq 0 ]; then
            COVERAGE=0
          else
            COVERAGE=$(awk "BEGIN { printf \"%.2f\", ($COVERED / ($COVERED + $MISSED)) * 100 }")
          fi

          echo "‚úÖ Cobertura total: $COVERAGE%"
          echo "üìä Umbral requerido: ${{ inputs.coverage-threshold }}%"

          if (( $(echo "$COVERAGE < ${{ inputs.coverage-threshold }}" | bc -l) )); then
            echo "‚ö†Ô∏è La cobertura est√° por debajo del umbral requerido."
            if [ "${{ inputs.fail-on-coverage }}" = "true" ]; then
              echo "‚ùå Fallando el job debido a cobertura insuficiente."
              exit 1
            else
              echo "üîî Advertencia: cobertura baja, pero no se fallar√° el job."
            fi
          else
            echo "‚úÖ Cobertura suficiente. Continuando con el pipeline."
          fi