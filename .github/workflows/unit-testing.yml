name: 'Unit Testing'
on:
  workflow_call:
    inputs:
      java-version:
        description: 'Java version to use'
        required: false
        type: string
        default: '17'
      coverage-threshold:
        description: 'Minimum coverage threshold percentage'
        required: false
        type: number
        default: 50
      test-profile:
        description: 'Maven test profile to use'
        required: false
        type: string
        default: 'default'
      fail-on-coverage:
        description: 'Whether to fail if coverage threshold is not met'
        required: false
        type: boolean
        default: false
      stack:
        description: "Detected technology stack"
        required: true
        type: string

        
    outputs:
      tests-passed:
        description: 'Whether all tests passed'
        value: ${{ jobs.unit-tests.outputs.tests-passed }}
      tests-total:
        description: 'Total number of tests executed'
        value: ${{ jobs.unit-tests.outputs.tests-total }}
      coverage-percent:
        description: 'Code coverage percentage'
        value: ${{ jobs.unit-tests.outputs.coverage-percent }}
      coverage-threshold-met:
        description: 'Whether coverage threshold was met'
        value: ${{ jobs.unit-tests.outputs.coverage-threshold-met }}
      test-artifacts-ready:
        description: 'Whether test artifacts are ready for quality tools'
        value: ${{ jobs.unit-tests.outputs.test-artifacts-ready }}
      test-status:
        description: 'Overall test status (PASSED/WARNING/FAILED)'
        value: ${{ jobs.unit-tests.outputs.test-status }}

jobs:
  unit-tests:
    name: Unit Tests & Coverage
    runs-on: ubuntu-latest
    
    outputs:
      tests-passed: ${{ steps.process_results.outputs.tests-passed }}
      tests-total: ${{ steps.process_results.outputs.tests-total }}
      tests-failed: ${{ steps.process_results.outputs.tests-failed }}
      tests-skipped: ${{ steps.process_results.outputs.tests-skipped }}
      coverage-percent: ${{ steps.process_results.outputs.coverage-percent }}
      coverage-lines-covered: ${{ steps.process_results.outputs.coverage-lines-covered }}
      coverage-lines-total: ${{ steps.process_results.outputs.coverage-lines-total }}
      coverage-threshold-met: ${{ steps.process_results.outputs.coverage-threshold-met }}
      test-artifacts-ready: ${{ steps.process_results.outputs.test-artifacts-ready }}
      test-status: ${{ steps.determine_status.outputs.TEST_STATUS }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Java and Maven
        uses: ./.github/actions/setup-java-maven
        with:
          java-version: ${{ inputs.java-version }}
          
        
      - name: Verify build prerequisites
        run: |
          echo "üîç Verifying build prerequisites for testing..."
          
          # Check if we have compiled classes
          if [ ! -d "target/classes" ]; then
            echo "‚ö†Ô∏è No compiled classes found - will compile first"
            echo "üì¶ Compiling sources for testing..."
            mvn compile -q
          else
            echo "‚úÖ Compiled classes found"
            ls -la target/classes/
          fi
          
          # Verify test sources exist
          if [ -d "src/test/java" ]; then
            echo "‚úÖ Test sources found:"
            find src/test/java -name "*.java" | wc -l | xargs echo "   Test files:"
          else
            echo "‚ö†Ô∏è No test sources found in src/test/java"
          fi

		  - name: Run Unit Tests
		    id: run_tests
		    continue-on-error: true
		    run: |
		      STACK="${{ inputs.stack }}"
		      echo "üîç Detected stack for tests: $STACK"

		      mkdir -p test-results

		      # -------------------------
		      # JAVA / MAVEN
		      # -------------------------
		      if [ "$STACK" = "java-maven" ]; then
		        PROFILE_ARG=""
		        if [ "${{ inputs.test-profile }}" != "default" ]; then
		          PROFILE_ARG="-P${{ inputs.test-profile }}"
		        fi

		        echo "üöÄ Running Maven tests..."
		        mvn test jacoco:report $PROFILE_ARG \
		          -Dmaven.test.failure.ignore=false \
		          -Djacoco.skip=false || TEST_EXIT_CODE=$?

		        cp -r target/surefire-reports/* test-results/ || true
		        cp -r target/site/jacoco/* test-results/ || true
		      fi

		      # -------------------------
		      # JAVA / GRADLE
		      # -------------------------
		      if [ "$STACK" = "java-gradle" ]; then
		        echo "üöÄ Running Gradle tests..."
		        ./gradlew test || TEST_EXIT_CODE=$?

		        cp -r build/test-results/test/* test-results/ || true
		        cp -r build/reports/* test-results/ || true
		      fi

		      # -------------------------
		      # NODE / ANGULAR
		      # -------------------------
		      if [ "$STACK" = "nodejs" ] || [ "$STACK" = "angular" ]; then
		        echo "üì¶ Installing Node dependencies..."
		        npm install

		        echo "üöÄ Running Node/Angular tests..."
		        npm test || TEST_EXIT_CODE=$?

		        cp -r coverage/* test-results/ || true
		      fi

		      # -------------------------
		      # PYTHON
		      # -------------------------
		      if [ "$STACK" = "python" ]; then
		        pip install -r requirements.txt || true
		        pytest --junitxml=test-results/results.xml || TEST_EXIT_CODE=$?
		      fi

		      echo "TEST_EXIT_CODE=${TEST_EXIT_CODE:-0}" >> $GITHUB_OUTPUT

		      echo "üìä Collected test results:"
		      ls -R test-results || true

		      exit ${TEST_EXIT_CODE:-0}


      - name: Process test results
        id: process_results
        if: always()
        uses: ./.github/actions/process-test-results
        with:
          test-reports-path: target/surefire-reports
          coverage-reports-path: target/site/jacoco
          coverage-threshold: ${{ inputs.coverage-threshold }}
          project-path: .

      - name: Determine overall test status
        id: determine_status
        if: always()
        run: |
          echo "üéØ Determining overall test status..."
          
          TESTS_PASSED="${{ steps.process_results.outputs.tests-passed }}"
          COVERAGE_MET="${{ steps.process_results.outputs.coverage-threshold-met }}"
          TEST_EXIT_CODE="${{ steps.run_tests.outputs.TEST_EXIT_CODE }}"
          
          # Determine status based on test results and coverage
          if [ "$TESTS_PASSED" = "true" ] && [ "$COVERAGE_MET" = "true" ]; then
            TEST_STATUS="PASSED"
            STATUS_ICON="‚úÖ"
            STATUS_MESSAGE="All tests passed and coverage threshold met"
          elif [ "$TESTS_PASSED" = "true" ] && [ "$COVERAGE_MET" = "false" ]; then
            TEST_STATUS="WARNING" 
            STATUS_ICON="‚ö†Ô∏è"
            STATUS_MESSAGE="Tests passed but coverage below threshold (${{ inputs.coverage-threshold }}%)"
          elif [ "$TESTS_PASSED" = "false" ] || [ "${TEST_EXIT_CODE:-0}" -ne 0 ]; then
            TEST_STATUS="FAILED"
            STATUS_ICON="‚ùå"
            STATUS_MESSAGE="Some tests failed or test execution error occurred"
          else
            TEST_STATUS="UNKNOWN"
            STATUS_ICON="‚ùì"
            STATUS_MESSAGE="Unable to determine test status"
          fi
          
          echo "TEST_STATUS=$TEST_STATUS" >> $GITHUB_OUTPUT
          echo "STATUS_ICON=$STATUS_ICON" >> $GITHUB_OUTPUT
          echo "STATUS_MESSAGE=$STATUS_MESSAGE" >> $GITHUB_OUTPUT
          
          echo ""
          echo "$STATUS_ICON Final Test Status: $TEST_STATUS"
          echo "üìã $STATUS_MESSAGE"

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            test-results/
            target/surefire-reports/
            target/site/jacoco/
          retention-days: 3
          
      - name: Generate concise test summary
        if: always()
        run: |
          # Determine coverage threshold status
          COVERAGE_STATUS=""
          if [ "${{ steps.process_results.outputs.coverage-threshold-met }}" = "true" ]; then
            COVERAGE_STATUS="‚úÖ Met"
          else
            COVERAGE_STATUS="‚ö†Ô∏è Below threshold"
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ${{ steps.determine_status.outputs.STATUS_ICON }} Unit Tests & Coverage: **${{ steps.determine_status.outputs.TEST_STATUS }}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ steps.process_results.outputs.tests-total }} total, ${{ steps.process_results.outputs.tests-failed }} failed, ${{ steps.process_results.outputs.tests-skipped }} skipped |" >> $GITHUB_STEP_SUMMARY
          echo "| Coverage | ${{ steps.process_results.outputs.coverage-percent }}% (${{ steps.process_results.outputs.coverage-lines-covered }}/${{ steps.process_results.outputs.coverage-lines-total }} lines) - Threshold (${{ inputs.coverage-threshold }}%): $COVERAGE_STATUS |" >> $GITHUB_STEP_SUMMARY

      - name: Evaluate test status for workflow continuation
        if: always()
        run: |
          TEST_STATUS="${{ steps.determine_status.outputs.TEST_STATUS }}"
          FAIL_ON_COVERAGE="${{ inputs.fail-on-coverage }}"
          
          echo "üéØ Evaluating workflow continuation criteria..."
          echo "   Test Status: $TEST_STATUS"
          echo "   Fail on Coverage: $FAIL_ON_COVERAGE"
          
          case "$TEST_STATUS" in
            "PASSED")
              echo "‚úÖ All criteria met - workflow can continue"
              exit 0
              ;;
            "WARNING")
              if [ "$FAIL_ON_COVERAGE" = "true" ]; then
                echo "‚ùå Coverage threshold not met and fail-on-coverage is enabled"
                exit 1
              else
                echo "‚ö†Ô∏è Coverage warning but continuing (fail-on-coverage: false)"
                exit 0
              fi
              ;;
            "FAILED")
              echo "‚ùå Tests failed - stopping workflow"
              exit 1
              ;;
            *)
              echo "‚ùì Unknown test status - continuing with caution"
              exit 0
              ;;
          esac