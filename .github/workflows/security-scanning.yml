name: 'Security Scanning'
permissions:
  contents: read
  security-events: write

on:
  workflow_call:
    inputs:
      java-version:
        description: 'Java version to use'
        required: false
        type: string
        default: '17'
    secrets:
      SNYK_TOKEN:
        required: true
      SNYK_ORG_ID:
        required: true

    outputs:
      critical-count:
        description: 'Number of critical vulnerabilities found'
        value: ${{ jobs.security-scan.outputs.critical-count }}
      high-count:
        description: 'Number of high vulnerabilities found'
        value: ${{ jobs.security-scan.outputs.high-count }}
      medium-count:
        description: 'Number of medium vulnerabilities found'
        value: ${{ jobs.security-scan.outputs.medium-count }}
      low-count:
        description: 'Number of low vulnerabilities found'
        value: ${{ jobs.security-scan.outputs.low-count }}

jobs:
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    outputs:
      critical-count: ${{ steps.security-summary.outputs.critical-count }}
      high-count: ${{ steps.security-summary.outputs.high-count }}
      medium-count: ${{ steps.security-summary.outputs.medium-count }}
      low-count: ${{ steps.security-summary.outputs.low-count }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java and Maven
        uses: ./.github/actions/setup-java-maven
        with:
          java-version: ${{ inputs.java-version }}

      - name: Download build artifacts
        uses: ./.github/actions/download-build-artifacts
        continue-on-error: true

      - name: Validate Snyk configuration
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
          SNYK_ORG_ID: ${{ secrets.SNYK_ORG_ID }}
        run: |
          chmod +x snyk-scanning/scripts/validate-snyk.sh || true
          ./snyk-scanning/scripts/validate-snyk.sh || true

      - name: Run Snyk dependency scan
        id: snyk_test
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
          SNYK_ORG_ID: ${{ secrets.SNYK_ORG_ID }}
        run: |
          npm install -g snyk
          snyk auth $SNYK_TOKEN
          mkdir -p snyk-scanning/results
          snyk test --json > snyk-scanning/results/snyk-results.json || true
          snyk code test --json > snyk-scanning/results/snyk-code-results.json || true
          ls -la snyk-scanning/results || true

      - name: Send results to Snyk Monitor (Advanced)
        if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release') || github.event_name == 'workflow_dispatch'
        env:
         SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
         SNYK_ORG_ID: ${{ secrets.SNYK_ORG_ID }}
        run: |
         echo "ðŸ” Searching for pom.xml files..."
         POMS=$(find . -maxdepth 4 -name "pom.xml")

         echo "ðŸ“ Found the following pom.xml files:"
         echo "$POMS"

         if [ -z "$POMS" ]; then
         echo "âŒ No pom.xml found. Cannot run snyk monitor."
         exit 0
         fi

         # Use mvnw if available, fallback to mvn
         if [ -f "./mvnw" ]; then
         MVN="./mvnw -q"
         echo "âœ” Using Maven Wrapper (mvnw)"
         else
         MVN="mvn -q"
         echo "âœ” Using system Maven (mvn)"
         fi

         # Loop through all pom.xml files
         for POM in $POMS; do
         DIR=$(dirname "$POM")

         echo ""
         echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
         echo "ðŸ“Œ Processing module:"
         echo "ðŸ“ Directory: $DIR"
         echo "ðŸ“„ POM: $POM"
         echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

         cd "$DIR"
         echo "ðŸ“¦ Generating dependency tree..."
         $MVN dependency:tree -DoutputType=dot --batch-mode --non-recursive || echo "âš  Maven dependency tree failed"

         echo "ðŸ›° Running Snyk monitor..."
         snyk monitor \
         --file=pom.xml \
         --package-manager=maven \
         --all-projects=false \
         --org=$SNYK_ORG_ID \
         --project-name="cicd-pipeline-poc:${DIR#./}" \
         || echo "âš  Snyk monitor failed for $DIR"

         cd - > /dev/null
         done

         echo "âœ… Snyk monitor execution completed"


      - name: Generate security summary
        id: security-summary
        uses: ./.github/actions/generate-security-summary
        with:
          results-file: snyk-scanning/results/snyk-results.json

      - name: Upload security scan results
        uses: actions/upload-artifact@v4
        with:
          name: security-results
          path: |
            snyk-scanning/results/snyk-results.json
            snyk-scanning/results/snyk-code-results.json
          if-no-files-found: warn
          retention-days: 3
