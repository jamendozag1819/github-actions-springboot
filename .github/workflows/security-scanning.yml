name: "Security Scanning"
permissions:
  contents: read
  security-events: write

on:
  workflow_call:
    inputs:
      java-version:
        description: "Java version to use"
        required: false
        type: string
        default: "17"
    secrets:
      SNYK_TOKEN:
        required: true
      SNYK_ORG_ID:
        required: true
      APP_ID:
        required: true
      JIRA_URL:
        required: true
      JIRA_USER:
        required: true
      JIRA_API_TOKEN:
        required: true
      JIRA_PROJECT:
        required: true

    outputs:
      critical-count: 
        description: "Number of critical vulnerabilities found" 
        value: ${{ jobs.security-scan.outputs.critical-count }} 
      high-count: 
        description: "Number of high vulnerabilities found" 
        value: ${{ jobs.security-scan.outputs.high-count }} 
      medium-count: 
        description: "Number of medium vulnerabilities found"
        value: ${{ jobs.security-scan.outputs.medium-count }} 
      low-count: 
        description: "Number of low vulnerabilities found" 
        value: ${{ jobs.security-scan.outputs.low-count }} 
      stack: 
        description: "Detected technology stack" 
        value: ${{ jobs.security-scan.outputs.stack }}

jobs:
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    outputs:
      critical-count: ${{ steps.security-summary-backend.outputs.critical-count }}
      high-count:     ${{ steps.security-summary-backend.outputs.high-count }}
      medium-count:   ${{ steps.security-summary-backend.outputs.medium-count }}
      low-count:      ${{ steps.security-summary-backend.outputs.low-count }}
      stack:          ${{ steps.export-stack.outputs.stack }}

    steps:

      # -----------------------------------------
      # Checkout
      # -----------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # -----------------------------------------
      # Setup Java
      # -----------------------------------------
      - name: Setup Java and Maven
        uses: ./.github/actions/setup-java-maven
        with:
          java-version: ${{ inputs.java-version }}

      # -----------------------------------------
      # Detect Stack
      # -----------------------------------------
      - name: Detect technology stack (Backend)
        id: detect-stack-backend
        run: |
          chmod +x ./scripts/snyk-tech.py
          python3 ./scripts/snyk-tech.py
          echo "Detected stack env: $SNYK_STACK"

      - name: Export stack output
        id: export-stack
        run: |
          echo "Exporting stack: $SNYK_STACK"
          echo "stack=$SNYK_STACK" >> $GITHUB_OUTPUT

      - name: Show detected stack
        run: |
          echo "Stack detected: ${{ steps.export-stack.outputs.stack }}"

      # -----------------------------------------
      # Map Command (solo para non-docker)
      # -----------------------------------------
      - name: Map Snyk command (Backend)
        id: map-command-backend
        if: steps.export-stack.outputs.stack != 'docker'
        run: |
          chmod +x ./scripts/snyk-command-map.py
          python3 ./scripts/snyk-command-map.py
          echo "Resolved SNYK_CMD: $SNYK_CMD"

      # -----------------------------------------
      # SAST + SCA (cuando NO es docker)
      # -----------------------------------------
      - name: Run Snyk Code (SAST Backend)
        if: steps.export-stack.outputs.stack != 'docker'
        id: snyk-code-backend
        uses: ./.github/actions/snyk-code-analysis
        with:
          app-path: "."
          snyk-token: ${{ secrets.SNYK_TOKEN }}
          snyk-org: ${{ secrets.SNYK_ORG_ID }}
          snyk-branch: ${{ github.ref_name }}
          gating-threshold-file: "./gating-configs/snyk_gating_thresholds_default.json"
          snyk-project-name: "jamendozag1819_github-actions-springboot"

      - name: Run Snyk Test (SCA Backend)
        if: steps.export-stack.outputs.stack != 'docker'
        id: snyk-test-backend
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
          SNYK_ORG_ID: ${{ secrets.SNYK_ORG_ID }}
        run: |
          echo "Running Snyk SCA with command: $SNYK_CMD"

          $SNYK_CMD \
            --org="${SNYK_ORG_ID}" \
            --json-file-output="snyk-scanning/results/snyk-results.json" \
            --token="${SNYK_TOKEN}" || true

      # -----------------------------------------
      # Container Scan (solo docker)
      # -----------------------------------------
      - name: Run Snyk Test (Docker)
        if: steps.export-stack.outputs.stack == 'docker'
        id: snyk-test-docker
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
          SNYK_ORG_ID: ${{ secrets.SNYK_ORG_ID }}
        run: |
          echo "Running Snyk Container Test for image myapp:${{ github.sha }}"
          snyk container test myapp:${{ github.sha }} \
            --file=Dockerfile \
            --org="${SNYK_ORG_ID}" \
            --json-file-output="snyk-scanning/results/snyk-results.json" \
            --token="${SNYK_TOKEN}" || true

      - name: Upload security results (Docker)
        if: steps.export-stack.outputs.stack == 'docker'
        uses: actions/upload-artifact@v4
        with:
          name: security-results
          path: snyk-scanning/results/snyk-results.json
