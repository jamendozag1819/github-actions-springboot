name: 'Security Scanning'
permissions:
  contents: read
  security-events: write

on:
  workflow_call:
    inputs:
      java-version:
        description: 'Java version to use'
        required: false
        type: string
        default: '17'
    secrets:
      SNYK_TOKEN:
        required: true
      SNYK_ORG_ID:
        required: true

    outputs:
      critical-count:
        description: 'Number of critical vulnerabilities found'
        value: ${{ jobs.security-scan.outputs.critical-count }}
      high-count:
        description: 'Number of high vulnerabilities found'
        value: ${{ jobs.security-scan.outputs.high-count }}
      medium-count:
        description: 'Number of medium vulnerabilities found'
        value: ${{ jobs.security-scan.outputs.medium-count }}
      low-count:
        description: 'Number of low vulnerabilities found'
        value: ${{ jobs.security-scan.outputs.low-count }}

jobs:
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    outputs:
      critical-count: ${{ steps.security-summary.outputs.critical-count }}
      high-count: ${{ steps.security-summary.outputs.high-count }}
      medium-count: ${{ steps.security-summary.outputs.medium-count }}
      low-count: ${{ steps.security-summary.outputs.low-count }}

    steps:

      # --------------------------
      # Checkout
      # --------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # --------------------------
      # Setup Java (solo si aplica)
      # --------------------------
      - name: Setup Java and Maven
        uses: ./.github/actions/setup-java-maven
        with:
          java-version: ${{ inputs.java-version }}

      # --------------------------
      # Optional: download artifacts
      # --------------------------
      - name: Download build artifacts
        uses: ./.github/actions/download-build-artifacts
        continue-on-error: true

      # --------------------------
      # Detect tech stack (multi-stack)
      # --------------------------
      - name: Detect technology stack
        id: detect-stack
        run: |
          chmod +x ./scripts/snyk-tech.py
          python3 ./scripts/snyk-tech.py
        shell: bash

      - name: Show detected stacks
        run: |
          echo "Detected stacks: $SNYK_STACKS"

      # --------------------------
      # Map stack -> CLI command
      # --------------------------
      - name: Map Snyk command
        id: map-command
        run: |
          chmod +x scripts/snyk-command-map.py
          python3 scripts/snyk-command-map.py
          echo "Resolved command: $SNYK_CMD"
        shell: bash

      - name: Show Snyk command
        run: |
          echo "Final Snyk command: $SNYK_CMD"

      # --------------------------
      # Run Snyk Code Analysis
      # --------------------------
      - name: Run Snyk Code (SAST)
        id: snyk-code
        uses: ./.github/actions/snyk-code-analysis
        with:
          app-path: "."
          snyk-token: ${{ secrets.SNYK_TOKEN }}
          snyk-org: ${{ secrets.SNYK_ORG_ID }}
          snyk-branch: ${{ github.ref_name }}
          gating-threshold-file: "./gating-configs/snyk_gating_thresholds.json"
          snyk-project-name: cicd-pipeline-poc/microservice-moc-app-deps

      # --------------------------
      # Run Snyk Test (dependency scan)
      # --------------------------
      - name: Run Snyk Test
        id: snyk-test
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
          SNYK_ORG_ID: ${{ secrets.SNYK_ORG_ID }}
        run: |
          echo "Running: $SNYK_CMD"
          $SNYK_CMD \
            --org="${SNYK_ORG_ID}" \
            --project-name="secure-project" \
            --json-file-output="snyk-scanning/results/snyk-results.json" \
            --token="${SNYK_TOKEN}" || true

      # --------------------------
      # Summary generation
      # --------------------------
      - name: Generate security summary
        id: security-summary
        uses: ./.github/actions/generate-security-summary
        with:
          results-file: snyk-scanning/results/snyk-results.json

      # --------------------------
      # Store artifacts
      # --------------------------
      - name: Upload security scan results
        uses: actions/upload-artifact@v4
        with:
          name: security-results
          path: |
            snyk-scanning/results/snyk-results.json
            snyk-scanning/results/snyk-code-results.json
          if-no-files-found: warn
          retention-days: 3
