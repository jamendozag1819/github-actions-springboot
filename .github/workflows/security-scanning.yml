name: 'Security Scanning'
permissions:
  contents: read
  security-events: write

on:
  workflow_call:
    inputs:
      java-version:
        description: 'Java version to use'
        required: false
        type: string
        default: '17'
    secrets:
      SNYK_TOKEN:
        required: true
      SNYK_ORG_ID:
        required: true

    outputs:
      critical-count:
        description: 'Number of critical vulnerabilities found'
        value: ${{ jobs.security-scan.outputs.critical-count }}
      high-count:
        description: 'Number of high vulnerabilities found'
        value: ${{ jobs.security-scan.outputs.high-count }}
      medium-count:
        description: 'Number of medium vulnerabilities found'
        value: ${{ jobs.security-scan.outputs.medium-count }}
      low-count:
        description: 'Number of low vulnerabilities found'
        value: ${{ jobs.security-scan.outputs.low-count }}

jobs:
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    outputs:
      critical-count: ${{ steps.security-summary.outputs.critical-count }}
      high-count: ${{ steps.security-summary.outputs.high-count }}
      medium-count: ${{ steps.security-summary.outputs.medium-count }}
      low-count: ${{ steps.security-summary.outputs.low-count }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java and Maven
        uses: ./.github/actions/setup-java-maven
        with:
          java-version: ${{ inputs.java-version }}

      - name: Download build artifacts
        uses: ./.github/actions/download-build-artifacts
        continue-on-error: true

      - name: Validate Snyk configuration
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
          SNYK_ORG_ID: ${{ secrets.SNYK_ORG_ID }}
        run: |
          chmod +x snyk-scanning/scripts/validate-snyk.sh || true
          ./snyk-scanning/scripts/validate-snyk.sh || true

      - name: Run Snyk dependency scan
        id: snyk_test
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
          SNYK_ORG_ID: ${{ secrets.SNYK_ORG_ID }}
        run: |
          npm install -g snyk
          snyk auth $SNYK_TOKEN
          mkdir -p snyk-scanning/results
          snyk test --json > snyk-scanning/results/snyk-results.json || true
          snyk code test --json > snyk-scanning/results/snyk-code-results.json || true
          ls -la snyk-scanning/results || true

      - name: Send results to Snyk Monitor (optional)
        if: startsWith(github.ref, 'refs/heads/main') ||
         startsWith(github.ref, 'refs/heads/release') ||
         github.event_name == 'workflow_dispatch'

        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          cd api-springboot
          snyk monitor --org=${{ secrets.SNYK_ORG_ID }} --project-name="cicd-pipeline-poc" || true

      - name: Generate security summary
        id: security-summary
        uses: ./.github/actions/generate-security-summary
        with:
          results-file: snyk-scanning/results/snyk-results.json

      - name: Upload security scan results
        uses: actions/upload-artifact@v4
        with:
          name: security-results
          path: |
            snyk-scanning/results/snyk-results.json
            snyk-scanning/results/snyk-code-results.json
          if-no-files-found: warn
          retention-days: 3
