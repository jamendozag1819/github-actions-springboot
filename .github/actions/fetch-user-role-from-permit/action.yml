name: 'Fetch User Role from Permit.io'
description: 'Fetches the actual user role from Permit.io cloud configuration'

inputs:
  permit-api-key:
    description: 'Permit.io API key'
    required: true
  user-key:
    description: 'User key (GitHub username)'
    required: true
  pdp-url:
    description: 'PDP URL for authorization requests'
    required: false
    default: 'http://localhost:7766'
  compose-file:
    description: 'Path to docker-compose file for PDP'
    required: false
    default: 'permit-gating/docker/docker-compose.gating.yml'
  timeout:
    description: 'Timeout in seconds for PDP startup'
    required: false
    default: '30'

outputs:
  user-role:
    description: 'User role from Permit.io (security, editor, developer, ci-pipeline)'
    value: ${{ steps.fetch-role.outputs.user-role }}
  role-found:
    description: 'Whether the role was successfully fetched from Permit.io'
    value: ${{ steps.fetch-role.outputs.role-found }}
  access-level:
    description: 'Access level based on Permit.io role'
    value: ${{ steps.fetch-role.outputs.access-level }}

runs:
  using: 'composite'
  steps:
    - name: Fetch User Role from Permit.io
      id: fetch-role
      shell: bash
      env:
        PERMIT_API_KEY: ${{ inputs.permit-api-key }}
        USER_KEY: ${{ inputs.user-key }}
        PDP_URL: ${{ inputs.pdp-url }}
      run: |
        echo "ðŸ” Fetching role for user: $USER_KEY from Permit.io..."
        
        # Initialize outputs
        USER_ROLE=""
        ROLE_FOUND="false"
        ACCESS_LEVEL="SAFE_ONLY"
        
        # Check if PDP is already running
        PDP_WAS_RUNNING=false
        if curl -sf http://localhost:7001/healthy > /dev/null 2>&1; then
          echo "âœ… PDP already running"
          PDP_WAS_RUNNING=true
        else
          # Start PDP temporarily for role fetching
          echo "ðŸš€ Starting temporary PDP for role fetching..."
          docker compose -f ${{ inputs.compose-file }} up -d permit-pdp > /dev/null 2>&1
          
          # Wait for PDP readiness with exponential backoff
          echo "â³ Waiting for PDP readiness..."
          TIMEOUT=${{ inputs.timeout }}
          ELAPSED=0
          WAIT_TIME=1
          
          while [ $ELAPSED -lt $TIMEOUT ]; do
            if curl -sf http://localhost:7001/healthy > /dev/null 2>&1; then
              echo "âœ… PDP ready after ${ELAPSED}s"
              break
            fi
            
            if [ $ELAPSED -ge $TIMEOUT ]; then
              echo "âš ï¸ PDP timeout after ${TIMEOUT}s - role fetch failed"
              echo "user-role=" >> $GITHUB_OUTPUT
              echo "role-found=false" >> $GITHUB_OUTPUT
              echo "access-level=SAFE_ONLY" >> $GITHUB_OUTPUT
              
              # Clean up PDP if we started it
              if [ "$PDP_WAS_RUNNING" = "false" ]; then
                docker compose -f ${{ inputs.compose-file }} down > /dev/null 2>&1
              fi
              exit 0
            fi
            
            sleep $WAIT_TIME
            ELAPSED=$((ELAPSED + WAIT_TIME))
            # Exponential backoff: 1, 2, 4, 8... up to 8 seconds
            if [ $WAIT_TIME -lt 8 ]; then
              WAIT_TIME=$((WAIT_TIME * 2))
            fi
          done
        fi
        
        # Make authorization call to determine user's role
        echo "ðŸ“¡ Querying Permit.io for user role..."
        AUTH_RESPONSE=$(curl -s -X POST $PDP_URL/allowed \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer $PERMIT_API_KEY" \
          -d "{
            \"user\": {
              \"key\": \"$USER_KEY\"
            },
            \"action\": \"deploy\",
            \"resource\": {
              \"type\": \"deployment\",
              \"key\": \"role-check\",
              \"tenant\": \"default\",
              \"attributes\": {
                \"criticalCount\": 0
              }
            }
          }" 2>/dev/null || echo "{}")
        
        # Extract role from response - try multiple possible locations
        if [ -n "$AUTH_RESPONSE" ] && [ "$AUTH_RESPONSE" != "{}" ]; then
          # Try primary location: debug.request.user.attributes.roles[0]
          if echo "$AUTH_RESPONSE" | jq -e '.debug.request.user.attributes.roles[0]' > /dev/null 2>&1; then
            USER_ROLE=$(echo "$AUTH_RESPONSE" | jq -r '.debug.request.user.attributes.roles[0]')
            ROLE_FOUND="true"
            echo "   âœ… Found role in primary location: $USER_ROLE"
          # Try alternative: debug.rbac.user_roles[0]
          elif echo "$AUTH_RESPONSE" | jq -e '.debug.rbac.user_roles[0]' > /dev/null 2>&1; then
            USER_ROLE=$(echo "$AUTH_RESPONSE" | jq -r '.debug.rbac.user_roles[0]')
            ROLE_FOUND="true"
            echo "   âœ… Found role in rbac location: $USER_ROLE"
          # Try another alternative: debug.rbac.allowing_roles[0]
          elif echo "$AUTH_RESPONSE" | jq -e '.debug.rbac.allowing_roles[0]' > /dev/null 2>&1; then
            USER_ROLE=$(echo "$AUTH_RESPONSE" | jq -r '.debug.rbac.allowing_roles[0]')
            ROLE_FOUND="true"
            echo "   âœ… Found role in allowing_roles: $USER_ROLE"
          else
            echo "   âš ï¸ Could not extract role from Permit.io response"
            echo "   Debug: Response structure:"
            echo "$AUTH_RESPONSE" | jq '.' 2>/dev/null || echo "Invalid JSON"
          fi
        else
          echo "   âš ï¸ No response from Permit.io"
        fi
        
        # Map Permit.io role to access level
        if [ "$ROLE_FOUND" = "true" ] && [ -n "$USER_ROLE" ]; then
          case "$USER_ROLE" in
            "security"|"Security Officer"|"security-admin")
              ACCESS_LEVEL="FULL_OVERRIDE"
              echo "   ðŸ›¡ï¸ Security role detected: Full override capabilities"
              ;;
            "editor"|"release-manager")
              ACCESS_LEVEL="EMERGENCY_OVERRIDE"
              echo "   âœï¸ Editor role detected: Emergency override capabilities"
              ;;
            "developer")
              ACCESS_LEVEL="SAFE_ONLY"
              echo "   ðŸ‘¨â€ðŸ’» Developer role detected: Safe deployments only"
              ;;
            "ci-pipeline"|"ci_pipeline")
              ACCESS_LEVEL="SAFE_ONLY"
              echo "   ðŸ¤– CI Pipeline role detected: Safe deployments only"
              ;;
            *)
              ACCESS_LEVEL="SAFE_ONLY"
              echo "   ðŸ‘¤ Unknown role '$USER_ROLE': Defaulting to safe deployments only"
              ;;
          esac
        else
          echo "   â„¹ï¸ No role found in Permit.io for user: $USER_KEY"
        fi
        
        # Clean up PDP if we started it
        if [ "$PDP_WAS_RUNNING" = "false" ]; then
          echo "ðŸ§¹ Cleaning up temporary PDP..."
          docker compose -f ${{ inputs.compose-file }} down > /dev/null 2>&1
        fi
        
        # Set outputs
        echo "user-role=$USER_ROLE" >> $GITHUB_OUTPUT
        echo "role-found=$ROLE_FOUND" >> $GITHUB_OUTPUT
        echo "access-level=$ACCESS_LEVEL" >> $GITHUB_OUTPUT
        
        # Summary
        echo ""
        echo "ðŸ“Š Role Fetch Summary:"
        echo "   User: $USER_KEY"
        if [ "$ROLE_FOUND" = "true" ]; then
          echo "   Role: $USER_ROLE"
          echo "   Access Level: $ACCESS_LEVEL"
        else
          echo "   Role: Not found in Permit.io"
          echo "   Access Level: Default (SAFE_ONLY)"
        fi