name: 'Determine User Role'
description: 'Maps GitHub username to Permit.io role and access level for Safe Deployment Gate'

inputs:
  github-user:
    description: 'GitHub username to map to role'
    required: true
  role-mapping:
    description: 'JSON string mapping users to roles (optional, uses Permit.io if not provided)'
    required: false
    default: '{}'
  permit-api-key:
    description: 'Permit.io API key (required for dynamic role fetching)'
    required: false
    default: ''
  enable-dynamic-roles:
    description: 'Enable fetching roles from Permit.io cloud'
    required: false
    default: 'true'

outputs:
  user-role:
    description: 'Permit.io role (Security Officer, editor, developer, ci-pipeline)'
    value: ${{ steps.determine-role.outputs.user-role }}
  access-level:
    description: 'Access level (FULL_OVERRIDE, EMERGENCY_OVERRIDE, SAFE_ONLY)'
    value: ${{ steps.determine-role.outputs.access-level }}
  role-description:
    description: 'Human-readable description of the role capabilities'
    value: ${{ steps.determine-role.outputs.role-description }}

runs:
  using: 'composite'
  steps:
    # First, try to fetch role from Permit.io if enabled
    - name: Fetch Role from Permit.io
      id: fetch-permit-role
      if: inputs.enable-dynamic-roles == 'true' && inputs.permit-api-key != ''
      uses: ./.github/actions/fetch-user-role-from-permit
      with:
        permit-api-key: ${{ inputs.permit-api-key }}
        user-key: ${{ inputs.github-user }}
    
    - name: Determine User Role and Access Level
      id: determine-role
      shell: bash
      run: |
        GITHUB_USER="${{ inputs.github-user }}"
        CUSTOM_MAPPING='${{ inputs.role-mapping }}'
        ENABLE_DYNAMIC="${{ inputs.enable-dynamic-roles }}"
        
        echo "ðŸ” Determining Safe Deployment Gate access level for: $GITHUB_USER"
        
        # Priority 1: Check if we got a role from Permit.io
        USER_ROLE=""
        PERMIT_ROLE="${{ steps.fetch-permit-role.outputs.user-role }}"
        ROLE_FOUND="${{ steps.fetch-permit-role.outputs.role-found }}"
        PERMIT_ACCESS="${{ steps.fetch-permit-role.outputs.access-level }}"
        
        if [ "$ENABLE_DYNAMIC" = "true" ] && [ "$ROLE_FOUND" = "true" ] && [ -n "$PERMIT_ROLE" ]; then
          echo "   âœ… Using role from Permit.io: $PERMIT_ROLE"
          USER_ROLE="$PERMIT_ROLE"
          # We'll use the access level from Permit.io fetch
        else
          # Priority 2: Check custom mapping if provided
          if [ "$CUSTOM_MAPPING" != "{}" ] && [ -n "$CUSTOM_MAPPING" ]; then
            USER_ROLE=$(echo "$CUSTOM_MAPPING" | jq -r --arg user "$GITHUB_USER" '.[$user] // ""')
            if [ -n "$USER_ROLE" ]; then
              echo "   ðŸ“‹ Using role from custom mapping: $USER_ROLE"
            fi
          fi
          
          # Priority 3: Use minimal default mapping for system accounts only
          if [ -z "$USER_ROLE" ]; then
            case "$GITHUB_USER" in
              "github-actions"|"dependabot[bot]"|"renovate[bot]")
                USER_ROLE="ci-pipeline"
                echo "   ðŸ¤– System account detected: $USER_ROLE"
                ;;
              *)
                USER_ROLE="developer"
                echo "   ðŸ‘¤ No role mapping found, defaulting to: $USER_ROLE"
                ;;
            esac
          fi
        fi
        
        # Map role to access level if not already set by Permit.io
        if [ "$ROLE_FOUND" = "true" ] && [ -n "$PERMIT_ACCESS" ]; then
          # Use the access level from Permit.io
          ACCESS_LEVEL="$PERMIT_ACCESS"
          echo "   ðŸ“¡ Using access level from Permit.io: $ACCESS_LEVEL"
        else
          # Map role to access level manually
          case "$USER_ROLE" in
            "security"|"Security Officer"|"security-admin")
              ACCESS_LEVEL="FULL_OVERRIDE"
              ROLE_DESC="Full override capabilities in Permit.io"
              echo "ðŸ›¡ï¸ Security Officer access: Full Safe Deployment Gate override capabilities"
              echo "   âœ… Safe Deployment Gate: Access when criticalCount = 0"
              echo "   ðŸ”“ Base Deployment: Override access for critical vulnerabilities"
              ;;
            "editor"|"release-manager")
              ACCESS_LEVEL="EMERGENCY_OVERRIDE"
              ROLE_DESC="Emergency override capabilities"
              echo "âœï¸ Editor access: Emergency deployment override capabilities"
              echo "   âœ… Safe Deployment Gate: Access when criticalCount = 0"
              echo "   âš ï¸ Emergency Override: Can deploy with critical vulnerabilities"
              ;;
            "ci-pipeline"|"ci_pipeline")
              ACCESS_LEVEL="SAFE_ONLY"
              ROLE_DESC="Automated system restricted to safe deployments"
              echo "ðŸ¤– CI Pipeline access: Automated system restricted to safe deployments"
              echo "   âœ… Safe Deployment Gate: Access ONLY when criticalCount = 0"
              ;;
            "developer"|*)
              ACCESS_LEVEL="SAFE_ONLY"
              ROLE_DESC="Standard user restricted to safe deployments"
              echo "ðŸ‘¨â€ðŸ’» Developer access: Standard user restricted to safe deployments"
              echo "   âœ… Safe Deployment Gate: Access ONLY when criticalCount = 0"
              echo "   âŒ Base Deployment: No access when critical vulnerabilities present"
              ;;
          esac
        fi
        
        # Normalize role names for consistency
        case "$USER_ROLE" in
          "security"|"security-admin")
            USER_ROLE="Security Officer"
            ;;
          "release-manager")
            USER_ROLE="editor"
            ;;
          "ci_pipeline")
            USER_ROLE="ci-pipeline"
            ;;
        esac
        
        # Set outputs
        echo "user-role=$USER_ROLE" >> $GITHUB_OUTPUT
        echo "access-level=$ACCESS_LEVEL" >> $GITHUB_OUTPUT
        echo "role-description=$ROLE_DESC" >> $GITHUB_OUTPUT
        
        echo ""
        echo "ðŸŽ¯ Final Role Assignment:"
        echo "   GitHub User: $GITHUB_USER"
        echo "   Permit.io Role: $USER_ROLE"
        echo "   Access Level: $ACCESS_LEVEL"