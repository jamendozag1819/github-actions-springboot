name: 'Evaluate Quality Gates'
description: 'Evaluates SonarQube, Codacy, and test results quality gates'

inputs:
  sonarqube-results-path:
    description: 'Path to SonarQube quality gate results'
    required: false
    default: 'sonarqube-cloud-scanning/results/quality-gate-result.json'
  codacy-results-path:
    description: 'Path to Codacy quality gate results'
    required: false
    default: 'codacy-scanning/results/quality-gate-result.json'
  test-results-path:
    description: 'Path to test results summary'
    required: false
    default: 'test-results/processed/test-summary.json'
  enable-sonarqube:
    description: 'Enable SonarQube quality gate evaluation'
    required: false
    default: 'true'
  enable-codacy:
    description: 'Enable Codacy quality gate evaluation'
    required: false
    default: 'true'
  enable-tests:
    description: 'Enable test results evaluation'
    required: false
    default: 'true'

outputs:
  sonarqube-result:
    description: 'SonarQube gate result (0=pass, 1=warning, 2=fail)'
    value: ${{ steps.evaluate-quality.outputs.sonarqube-result }}
  sonarqube-reason:
    description: 'SonarQube gate decision reason'
    value: ${{ steps.evaluate-quality.outputs.sonarqube-reason }}
  codacy-result:
    description: 'Codacy gate result (0=pass, 1=warning, 2=fail)'
    value: ${{ steps.evaluate-quality.outputs.codacy-result }}
  codacy-reason:
    description: 'Codacy gate decision reason'
    value: ${{ steps.evaluate-quality.outputs.codacy-reason }}
  codacy-grade:
    description: 'Codacy code quality grade'
    value: ${{ steps.evaluate-quality.outputs.codacy-grade }}
  test-result:
    description: 'Test gate result (0=pass, 1=warning, 2=fail)'
    value: ${{ steps.evaluate-quality.outputs.test-result }}
  test-reason:
    description: 'Test gate decision reason'
    value: ${{ steps.evaluate-quality.outputs.test-reason }}
  combined-quality-result:
    description: 'Combined quality gate result (worst of all gates)'
    value: ${{ steps.evaluate-quality.outputs.combined-quality-result }}

runs:
  using: 'composite'
  steps:
    - name: Install jq for JSON processing
      shell: bash
      run: |
        if ! command -v jq &> /dev/null; then
          sudo apt-get update -qq
          sudo apt-get install -y jq
        fi
        
    - name: Evaluate Quality Gates
      id: evaluate-quality
      shell: bash
      run: |
        echo "ðŸ“Š Evaluating Quality Gates..."
        
        # Initialize results
        SONARQUBE_RESULT=0
        SONARQUBE_REASON="Not evaluated"
        CODACY_RESULT=0
        CODACY_REASON="Not evaluated"
        CODACY_GRADE="Unknown"
        TEST_RESULT=0
        TEST_REASON="Not evaluated"
        
        # Evaluate SonarQube quality gate
        if [ "${{ inputs.enable-sonarqube }}" = "true" ] && [ -f "${{ inputs.sonarqube-results-path }}" ]; then
          echo ""
          echo "ðŸ” Evaluating SonarQube quality gates..."
          
          QG_DECISION=$(jq -r '.quality_gate.decision // "UNKNOWN"' "${{ inputs.sonarqube-results-path }}")
          QG_REASON=$(jq -r '.quality_gate.reason // "No reason provided"' "${{ inputs.sonarqube-results-path }}")
          QG_EXIT_CODE=$(jq -r '.gate_result.exit_code // 0' "${{ inputs.sonarqube-results-path }}")
          
          # Extract quality ratings
          SECURITY_RATING=$(jq -r '.metrics.security_rating // "Unknown"' "${{ inputs.sonarqube-results-path }}")
          RELIABILITY_RATING=$(jq -r '.metrics.reliability_rating // "Unknown"' "${{ inputs.sonarqube-results-path }}")
          MAINTAINABILITY_RATING=$(jq -r '.metrics.maintainability_rating // "Unknown"' "${{ inputs.sonarqube-results-path }}")
          
          case "$QG_EXIT_CODE" in
            0)
              echo "âœ… SonarQube quality gate: PASSED"
              echo "   Ratings: Security($SECURITY_RATING) Reliability($RELIABILITY_RATING) Maintainability($MAINTAINABILITY_RATING)"
              echo "   Reason: $QG_REASON"
              SONARQUBE_RESULT=0
              SONARQUBE_REASON="$QG_REASON - Ratings: S($SECURITY_RATING) R($RELIABILITY_RATING) M($MAINTAINABILITY_RATING)"
              ;;
            1)
              echo "âš ï¸ SonarQube quality gate: WARNING"
              echo "   Reason: $QG_REASON"
              SONARQUBE_RESULT=1
              SONARQUBE_REASON="$QG_REASON"
              ;;
            2)
              echo "âŒ SonarQube quality gate: FAILED"
              echo "   Reason: $QG_REASON"
              SONARQUBE_RESULT=2
              SONARQUBE_REASON="$QG_REASON"
              ;;
            *)
              echo "â“ SonarQube quality gate: UNKNOWN"
              echo "   Reason: $QG_REASON"
              SONARQUBE_RESULT=0
              SONARQUBE_REASON="Unknown status - $QG_REASON"
              ;;
          esac
        else
          if [ "${{ inputs.enable-sonarqube }}" = "true" ]; then
            echo "â„¹ï¸ SonarQube quality gate not evaluated (results not available)"
          else
            echo "â„¹ï¸ SonarQube quality gate evaluation disabled"
          fi
        fi
        
        # Evaluate Codacy quality gate
        if [ "${{ inputs.enable-codacy }}" = "true" ] && [ -f "${{ inputs.codacy-results-path }}" ]; then
          echo ""
          echo "ðŸ“Š Evaluating Codacy quality gates..."
          
          CG_STATUS=$(jq -r '.quality_gate.status // "UNKNOWN"' "${{ inputs.codacy-results-path }}")
          CG_REASON=$(jq -r '.quality_gate.reason // "No reason provided"' "${{ inputs.codacy-results-path }}")
          CG_EXIT_CODE=$(jq -r '.gate_result.exit_code // 0' "${{ inputs.codacy-results-path }}")
          CG_GRADE=$(jq -r '.metrics.grade // "Unknown"' "${{ inputs.codacy-results-path }}")
          CG_ISSUES=$(jq -r '.metrics.issues_count // 0' "${{ inputs.codacy-results-path }}")
          CG_COVERAGE=$(jq -r '.metrics.coverage_percent // "N/A"' "${{ inputs.codacy-results-path }}")
          
          # Try to get coverage from analysis summary if not in quality gate result
          if [ "$CG_COVERAGE" = "N/A" ] || [ "$CG_COVERAGE" = "null" ]; then
            if [ -f "codacy-scanning/results/analysis-summary.json" ]; then
              CG_COVERAGE=$(jq -r '.coverage.percent // "N/A"' "codacy-scanning/results/analysis-summary.json")
            fi
          fi
          
          CODACY_GRADE="$CG_GRADE"
          
          case "$CG_EXIT_CODE" in
            0)
              echo "âœ… Codacy quality gate: PASSED"
              echo "   Grade: $CG_GRADE | Issues: $CG_ISSUES | Coverage: ${CG_COVERAGE}%"
              echo "   Reason: $CG_REASON"
              CODACY_RESULT=0
              CODACY_REASON="$CG_REASON - Grade: $CG_GRADE, Coverage: ${CG_COVERAGE}%"
              ;;
            1)
              echo "âš ï¸ Codacy quality gate: WARNING"
              echo "   Grade: $CG_GRADE | Issues: $CG_ISSUES | Coverage: ${CG_COVERAGE}%"
              echo "   Reason: $CG_REASON"
              CODACY_RESULT=1
              CODACY_REASON="$CG_REASON - Grade: $CG_GRADE, $CG_ISSUES issues"
              ;;
            2)
              echo "âŒ Codacy quality gate: FAILED"
              echo "   Grade: $CG_GRADE | Issues: $CG_ISSUES | Coverage: ${CG_COVERAGE}%"
              echo "   Reason: $CG_REASON"
              CODACY_RESULT=2
              CODACY_REASON="$CG_REASON - Grade: $CG_GRADE"
              ;;
            *)
              echo "â“ Codacy quality gate: UNKNOWN"
              echo "   Reason: $CG_REASON"
              CODACY_RESULT=0
              CODACY_REASON="Unknown status - $CG_REASON"
              ;;
          esac
        else
          if [ "${{ inputs.enable-codacy }}" = "true" ]; then
            echo "â„¹ï¸ Codacy quality gate not evaluated (results not available)"
          else
            echo "â„¹ï¸ Codacy quality gate evaluation disabled"
          fi
        fi
        
        # Evaluate unit test results
        if [ "${{ inputs.enable-tests }}" = "true" ] && [ -f "${{ inputs.test-results-path }}" ]; then
          echo ""
          echo "ðŸ§ª Evaluating unit test results..."
          
          TESTS_PASSED=$(jq -r '.test_results.passed // false' "${{ inputs.test-results-path }}")
          TESTS_TOTAL=$(jq -r '.test_results.total_tests // 0' "${{ inputs.test-results-path }}")
          TESTS_FAILED=$(jq -r '.test_results.failed_tests // 0' "${{ inputs.test-results-path }}")
          TESTS_SKIPPED=$(jq -r '.test_results.skipped_tests // 0' "${{ inputs.test-results-path }}")
          COVERAGE_PERCENT=$(jq -r '.coverage_results.coverage_percent // 0' "${{ inputs.test-results-path }}")
          COVERAGE_THRESHOLD=$(jq -r '.coverage_results.threshold // 50' "${{ inputs.test-results-path }}")
          COVERAGE_THRESHOLD_MET=$(jq -r '.coverage_results.threshold_met // false' "${{ inputs.test-results-path }}")
          
          if [ "$TESTS_PASSED" = "true" ] && [ "$COVERAGE_THRESHOLD_MET" = "true" ]; then
            echo "âœ… Unit tests: PASSED"
            echo "   Tests: ${TESTS_TOTAL} total (${TESTS_FAILED} failed, ${TESTS_SKIPPED} skipped)"
            echo "   Coverage: ${COVERAGE_PERCENT}% (threshold: ${COVERAGE_THRESHOLD}%)"
            TEST_RESULT=0
            TEST_REASON="All tests passed, coverage ${COVERAGE_PERCENT}% meets threshold"
          elif [ "$TESTS_PASSED" = "true" ] && [ "$COVERAGE_THRESHOLD_MET" = "false" ]; then
            echo "âš ï¸ Unit tests: WARNING"
            echo "   Tests: All ${TESTS_TOTAL} tests passed"
            echo "   Coverage: ${COVERAGE_PERCENT}% (below threshold of ${COVERAGE_THRESHOLD}%)"
            TEST_RESULT=1
            TEST_REASON="Tests passed but coverage ${COVERAGE_PERCENT}% below ${COVERAGE_THRESHOLD}% threshold"
          elif [ "$TESTS_PASSED" = "false" ]; then
            echo "âŒ Unit tests: FAILED"
            echo "   Tests: ${TESTS_FAILED} of ${TESTS_TOTAL} tests failed"
            echo "   Coverage: ${COVERAGE_PERCENT}%"
            TEST_RESULT=2
            TEST_REASON="${TESTS_FAILED} of ${TESTS_TOTAL} tests failed"
          else
            echo "â“ Unit tests: UNKNOWN"
            echo "   Unable to determine test status"
            TEST_RESULT=0
            TEST_REASON="Unable to determine test status"
          fi
        else
          if [ "${{ inputs.enable-tests }}" = "true" ]; then
            echo "â„¹ï¸ Unit test results not available for evaluation"
          else
            echo "â„¹ï¸ Unit test evaluation disabled"
          fi
        fi
        
        # Determine combined quality result (take the worst)
        COMBINED_RESULT=0
        if [ $SONARQUBE_RESULT -eq 2 ] || [ $CODACY_RESULT -eq 2 ] || [ $TEST_RESULT -eq 2 ]; then
          COMBINED_RESULT=2
          echo ""
          echo "ðŸš« Combined quality decision: BLOCKED"
          echo "   One or more quality gates failed"
        elif [ $SONARQUBE_RESULT -eq 1 ] || [ $CODACY_RESULT -eq 1 ] || [ $TEST_RESULT -eq 1 ]; then
          COMBINED_RESULT=1
          echo ""
          echo "âš ï¸ Combined quality decision: WARNING"
          echo "   Quality issues detected but non-blocking"
        else
          COMBINED_RESULT=0
          echo ""
          echo "âœ… Combined quality decision: PASSED"
          echo "   All quality gates passed"
        fi
        
        # Set outputs
        echo "sonarqube-result=$SONARQUBE_RESULT" >> $GITHUB_OUTPUT
        echo "sonarqube-reason=$SONARQUBE_REASON" >> $GITHUB_OUTPUT
        echo "codacy-result=$CODACY_RESULT" >> $GITHUB_OUTPUT
        echo "codacy-reason=$CODACY_REASON" >> $GITHUB_OUTPUT
        echo "codacy-grade=$CODACY_GRADE" >> $GITHUB_OUTPUT
        echo "test-result=$TEST_RESULT" >> $GITHUB_OUTPUT
        echo "test-reason=$TEST_REASON" >> $GITHUB_OUTPUT
        echo "combined-quality-result=$COMBINED_RESULT" >> $GITHUB_OUTPUT